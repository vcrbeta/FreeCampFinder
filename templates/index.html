{% extends "base.html" %}

{% block title %}Map View - FreeCampFinder{% endblock %}

{% block content %}
    <section>
        <h2>Find Camping Spots</h2>
        
        <!-- State Filter Dropdown -->
        <div style="margin-bottom: 1rem;">
            <label for="stateFilter"><strong>Filter by State:</strong></label>
            <select id="stateFilter" onchange="filterByState()" style="margin-left: 0.5rem; padding: 0.5rem;">
                <option value="all">All States</option>
                <optgroup label="Western States">
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="ID">Idaho</option>
                    <option value="MT">Montana</option>
                    <option value="NV">Nevada</option>
                    <option value="NM">New Mexico</option>
                    <option value="OR">Oregon</option>
                    <option value="UT">Utah</option>
                    <option value="WA">Washington</option>
                    <option value="WY">Wyoming</option>
                </optgroup>
                <optgroup label="Midwest States">
                    <option value="IA">Iowa</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="KS">Kansas</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MO">Missouri</option>
                    <option value="ND">North Dakota</option>
                    <option value="NE">Nebraska</option>
                    <option value="OH">Ohio</option>
                    <option value="SD">South Dakota</option>
                    <option value="WI">Wisconsin</option>
                </optgroup>
                <optgroup label="Southern States">
                    <option value="AL">Alabama</option>
                    <option value="AR">Arkansas</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="MS">Mississippi</option>
                    <option value="NC">North Carolina</option>
                    <option value="OK">Oklahoma</option>
                    <option value="SC">South Carolina</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="VA">Virginia</option>
                    <option value="WV">West Virginia</option>
                </optgroup>
                <optgroup label="Northeast States">
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MD">Maryland</option>
                    <option value="ME">Maine</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NY">New York</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="RI">Rhode Island</option>
                    <option value="VT">Vermont</option>
                </optgroup>
            </select>
        </div>

        <!-- Map -->
        <div id="map" style="height: 500px; margin-top: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 2px solid #ddd;"></div>
        
        <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
            <h4 style="margin: 0 0 0.5rem 0; color: #2a6f97;">How to Use:</h4>
            <ul style="margin: 0; padding-left: 1.5rem;">
                <li>Click on map markers to see camping spot details</li>
                <li>Use the layer control to toggle forest boundaries and roads</li>
                <li>Filter by state using the dropdown above</li>
                {% if session.user_id %}
                    <li>Explore the map freely, then use the form below to add camping spots</li>
                    <li>Optional: Toggle "Click to Add" mode to add spots by clicking the map</li>
                {% else %}
                    <li><a href="{{ url_for('login') }}">Login</a> to add new camping spots</li>
                {% endif %}
            </ul>
        </div>
    </section>

    <!-- Add Spot Form (always visible when logged in) -->
    {% if session.user_id %}
    <section style="margin-top: 2rem; padding: 1.5rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="color: #2a6f97; margin: 0;">Add a New Camping Spot</h3>
            <button id="toggle-click-mode" onclick="toggleClickMode()" style="background: #28a745; color: white; padding: 0.5rem 1rem; border: none; border-radius: 5px; cursor: pointer;">
                Enable Click-to-Add Mode
            </button>
        </div>
        
        <div id="click-mode-info" style="display: none; background: #e8f5e8; padding: 0.75rem; border-radius: 5px; margin-bottom: 1rem; border-left: 4px solid #28a745;">
            <strong>Click-to-Add Mode Active:</strong> Click anywhere on the map to quickly add a camping spot at that location.
        </div>
        
        <form id="add-spot-form" onsubmit="submitSpotForm(event)">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label for="spot-name" style="display: block; margin-bottom: 0.25rem; font-weight: bold;">Spot Name *</label>
                    <input type="text" id="spot-name" placeholder="e.g., Bear Creek Campsite" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" />
                </div>
                <div>
                    <label for="spot-state" style="display: block; margin-bottom: 0.25rem; font-weight: bold;">State *</label>
                    <input type="text" id="spot-state" placeholder="e.g., CO" required maxlength="2" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" />
                </div>
            </div>
            <div style="margin-bottom: 1rem;">
                <label for="spot-location" style="display: block; margin-bottom: 0.25rem; font-weight: bold;">Location Description *</label>
                <input type="text" id="spot-location" placeholder="e.g., Near Guanella Pass, off Forest Road 381" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" />
            </div>
            <div style="margin-bottom: 1rem;">
                <label for="spot-description" style="display: block; margin-bottom: 0.25rem; font-weight: bold;">Description</label>
                <textarea id="spot-description" placeholder="Details about the camping spot, amenities, road conditions, etc." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; height: 80px; resize: vertical;"></textarea>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label for="spot-latitude" style="display: block; margin-bottom: 0.25rem; font-weight: bold;">Latitude *</label>
                    <input type="number" id="spot-latitude" placeholder="39.6" step="any" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" />
                </div>
                <div>
                    <label for="spot-longitude" style="display: block; margin-bottom: 0.25rem; font-weight: bold;">Longitude *</label>
                    <input type="number" id="spot-longitude" placeholder="-105.3" step="any" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" />
                </div>
                <div style="display: flex; align-items: end;">
                    <button type="button" onclick="getCurrentLocation()" style="width: 100%; background: #6c757d; color: white; padding: 0.5rem; border: none; border-radius: 4px; cursor: pointer;">
                        Use My Location
                    </button>
                </div>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="submit" style="background: #2a6f97; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                    Add Camping Spot
                </button>
                <button type="button" onclick="clearForm()" style="background: #6c757d; color: white; padding: 0.75rem 1rem; border: none; border-radius: 5px; cursor: pointer;">
                    Clear Form
                </button>
            </div>
        </form>
    </section>
    {% endif %}
    
    <!-- Debug info -->
    <div style="margin-top: 2rem; padding: 1rem; background: #f0f0f0; border-radius: 8px; font-family: monospace; font-size: 0.9em;">
        <strong>Debug Info:</strong><br>
        Map container exists: <span id="map-debug">Checking...</span><br>
        JavaScript loaded: <span id="js-debug">Checking...</span><br>
        Session user: {{ session.username if session.user_id else 'Not logged in' }}
    </div>
{% endblock %}

{% block scripts %}
<script>
console.log("Page loaded, checking map initialization...");

let clickToAddMode = false;

// Debug info
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('map-debug').textContent = document.getElementById('map') ? 'Yes' : 'No';
    document.getElementById('js-debug').textContent = typeof initMap === 'function' ? 'Yes' : 'No';
    
    // Force map initialization if it didn't happen automatically
    if (typeof initMap === 'function') {
        console.log("Initializing map...");
        initMap();
    } else {
        console.error("initMap function not found!");
    }
});

function toggleClickMode() {
    clickToAddMode = !clickToAddMode;
    const button = document.getElementById('toggle-click-mode');
    const info = document.getElementById('click-mode-info');
    
    if (clickToAddMode) {
        button.textContent = 'Disable Click-to-Add Mode';
        button.style.background = '#dc3545';
        info.style.display = 'block';
    } else {
        button.textContent = 'Enable Click-to-Add Mode';
        button.style.background = '#28a745';
        info.style.display = 'none';
    }
}

function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            document.getElementById('spot-latitude').value = position.coords.latitude.toFixed(6);
            document.getElementById('spot-longitude').value = position.coords.longitude.toFixed(6);
        }, function(error) {
            alert('Unable to get your location: ' + error.message);
        });
    } else {
        alert('Geolocation is not supported by this browser.');
    }
}

function clearForm() {
    document.getElementById('add-spot-form').reset();
}

function submitSpotForm(event) {
    event.preventDefault();
    
    const name = document.getElementById('spot-name').value.trim();
    const location = document.getElementById('spot-location').value.trim();
    const description = document.getElementById('spot-description').value.trim();
    const state = document.getElementById('spot-state').value.trim().toUpperCase();
    const latitude = parseFloat(document.getElementById('spot-latitude').value);
    const longitude = parseFloat(document.getElementById('spot-longitude').value);
    
    if (!name || !location || !state || !latitude || !longitude) {
        alert('Please fill in all required fields (marked with *)');
        return;
    }
    
    if (state.length !== 2) {
        alert('State must be a 2-letter code (e.g., CO, CA, UT)');
        return;
    }
    
    if (typeof addCampingSpot === 'function') {
        addCampingSpot(name, location, description, state, latitude, longitude);
        clearForm();
    } else {
        alert('Map functions not loaded properly');
    }
}

// Function to be called from script.js when map is clicked
function handleMapClick(lat, lng) {
    if (clickToAddMode) {
        // Auto-fill coordinates
        document.getElementById('spot-latitude').value = lat.toFixed(6);
        document.getElementById('spot-longitude').value = lng.toFixed(6);
        
        // Scroll to form
        document.getElementById('add-spot-form').scrollIntoView({ behavior: 'smooth' });
        
        // Focus on name field
        document.getElementById('spot-name').focus();
    }
}

// Make function available globally
window.handleMapClick = handleMapClick;
window.clickToAddMode = () => clickToAddMode;
</script>
{% endblock %}